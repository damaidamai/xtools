## Context
- 首个功能需要最小可用的资产发现能力，子域枚举可作为后续扫描与防御的入口数据。
- 现有仓库尚未落地后端/前端骨架，需要同时考虑骨架搭建与子进程工具集成。
- 外部工具优先使用 Subfinder，保持轻依赖与快速运行。
- 字典是枚举质量关键输入，需要配套管理（上传/选择/默认），同时保证文件安全与大小可控。

## Goals / Non-Goals
- Goals: 异步触发子域枚举、捕获日志、去重存储结果、提供 API 与 UI 触发/查询。
- Non-Goals: 调度队列/定时器、多目标批量资产库、深度 DNS 校验证据、持久历史对比。
- Goals (字典): 支持上传/列出/设置默认枚举字典，任务可指定字典运行。

## Decisions
- 使用 FastAPI + AsyncIO/BackgroundTasks 异步运行子进程，避免引入额外队列组件。
- 构建 SQLite 表：`subdomain_runs`（状态、时间、输入、日志摘要）、`subdomains`（run_id、域名、来源、时间）。启用 WAL。
- 子进程调用默认使用 `subfinder -d <domain> -silent -json`（或等效输出），解析 JSON 行并去重；命令与路径通过配置/环境变量覆盖。
- 状态机：pending → running → succeeded/failed，记录 `started_at`、`finished_at` 与错误信息；日志/输出保留最近片段（设定大小上限）。
- API 采用轮询接口而非流式：POST 创建 run，GET run 状态/日志，GET run 结果；前端按固定间隔轮询即可。
- 前端 UI 采用 Minimal Dark 主题，左侧导航 + 右侧工作区布局：顶部概览（运行状态/默认字典提示），中部表单（域名输入、字典选择/上传、触发按钮），下方日志与结果表格；保持无厚重阴影、颜色红/蓝语义。
- 字典管理：新增 `wordlists` 表（id、name、path、size、is_default、created_at）。上传时校验文本/行数与大小上限（如 5-10MB），存储于受控目录；设置默认字典需幂等且只允许一个默认。枚举任务入参携带 wordlist_id；若为空使用默认。
- 安全性：限制上传 MIME/扩展名为文本，避免覆盖系统路径；对 Subfinder 调用添加超时与命令白名单。

## Risks / Trade-offs
- Subfinder 未安装或命令异常会导致失败：启动前做存在性检查并在状态中返回错误提示。
- 输出量大可能导致日志存储膨胀：限制存储长度，结果以去重列表存储。
- 单机异步可能限制并发：初期接受，后续可扩展为任务队列或并发度配置。
- 字典上传可能被滥用（过大或恶意内容）：设置大小阈值、仅存储文本，必要时进行行数限制与清洗。

## Migration Plan
- 首次落地，无历史迁移；保持表结构简单，后续扩展时做迁移脚本。

## Open Questions
- 是否需要支持自定义 resolvers/配置文件路径？先通过环境变量预留，未来根据需求扩展。
- 是否需要在 UI 中展示历史 run 列表或只展示当前 run？当前默认仅展示最新/当前 run，可后续按需求扩展。
- 字典是否需要共享/删除功能？初版仅支持上传、列出、设置默认，不做删除；如需删除需考虑引用 run 的记录一致性。
